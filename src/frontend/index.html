<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyParadise 실시간 데이터 대시보드</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1f2937;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            color: #1f2937;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            line-height: 1.2;
        }

        .header p {
            text-align: center;
            color: #6b7280;
            font-size: 1.1em;
            line-height: 1.5;
            max-width: 600px;
            margin: 0 auto;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .status-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-card .title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .status-card .value {
            font-size: 1.5em;
            font-weight: 700;
            color: #4299e1;
        }

        .status-card .subtitle {
            font-size: 0.9em;
            color: #718096;
            margin-top: 5px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .symbol-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            border-left: 4px solid #2563eb;
        }

        .symbol-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .symbol-card.up {
            border-left-color: #059669;
        }

        .symbol-card.down {
            border-left-color: #dc2626;
        }

        .symbol-card.neutral {
            border-left-color: #6b7280;
        }

        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .symbol-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
        }

        .symbol-source {
            font-size: 0.8em;
            color: #718096;
            background: #e2e8f0;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .price-info {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
        }

        .price-main {
            text-align: left;
        }

        .current-price {
            font-size: 2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .change-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .change {
            font-size: 1.1em;
            font-weight: 600;
        }

        .change.up {
            color: #48bb78;
        }

        .change.down {
            color: #f56565;
        }

        .change.neutral {
            color: #718096;
        }

        .change-percent {
            font-size: 0.9em;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.05);
        }

        .price-details {
            text-align: right;
        }

        .price-item {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 2px;
        }

        .price-item span {
            color: #2d3748;
            font-weight: 600;
        }

        .update-time {
            font-size: 0.8em;
            color: #a0aec0;
            margin-top: 10px;
            text-align: center;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .controls h3 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.loading {
            background: #6b7280;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.success { background: #059669; }
        .status-indicator.warning { background: #d97706; }
        .status-indicator.error { background: #dc2626; }
        .status-indicator.info { background: #2563eb; }
        .status-indicator.loading { background: #6b7280; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #2563eb;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { border-left-color: #059669; }
        .notification.error { border-left-color: #dc2626; }
        .notification.warning { border-left-color: #d97706; }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* TradingView 스타일 차트 인터페이스 */
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .symbol-info h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
            color: #1f2937;
        }

        .market-info {
            color: #6b7280;
            font-size: 0.9em;
            margin-top: 4px;
        }

        .price-info {
            text-align: right;
        }

        .current-price {
            margin-bottom: 8px;
        }

        .current-price .price {
            font-size: 1.5em;
            font-weight: 700;
            color: #1f2937;
        }

        .current-price .change {
            margin-left: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .current-price .change.positive {
            background: #dcfce7;
            color: #059669;
        }

        .current-price .change.negative {
            background: #fef2f2;
            color: #dc2626;
        }

        .price-details {
            display: flex;
            gap: 16px;
            font-size: 0.9em;
        }

        .price-item {
            display: flex;
            gap: 4px;
        }

        .price-item .label {
            color: #6b7280;
        }

        .price-item .value {
            font-weight: 600;
            color: #1f2937;
        }

        .chart-main {
            height: 400px;
            position: relative;
        }

        .chart-area {
            height: 100%;
            background: #fafafa;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .chart-placeholder {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-message {
            text-align: center;
            color: #6b7280;
        }

        .chart-message h3 {
            margin: 0 0 8px 0;
            font-size: 1.2em;
        }

        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .timeframe-selector {
            display: flex;
            gap: 4px;
        }

        .timeframe-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            color: #6b7280;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .timeframe-btn:hover {
            background: #f3f4f6;
        }

        .timeframe-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .chart-tools {
            display: flex;
            gap: 8px;
        }

        .tool-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            background: white;
            color: #6b7280;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .tool-btn:hover {
            background: #f3f4f6;
            color: #2563eb;
        }

        .indicators-panel {
            padding: 20px;
            background: white;
        }

        .indicators-panel h4 {
            margin: 0 0 16px 0;
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .indicator-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .indicator-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .indicator-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .indicator-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .indicator-status.bullish {
            background: #dcfce7;
            color: #059669;
        }

        .indicator-status.bearish {
            background: #fef2f2;
            color: #dc2626;
        }

        .indicator-status.neutral {
            background: #f3f4f6;
            color: #6b7280;
        }

        .indicator-status.warning {
            background: #fef3c7;
            color: #d97706;
        }

        .loading-message {
            margin-top: 20px;
            padding: 16px;
            background: #eff6ff;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
        }

        .loading-message p {
            margin: 0;
            color: #1e40af;
            text-align: center;
        }

        .btn.secondary {
            background: #059669;
        }

        .btn.secondary:hover {
            background: #047857;
        }

        .btn.danger {
            background: #dc2626;
        }

        .btn.danger:hover {
            background: #b91c1c;
        }

        .logs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .logs h3 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border-left: 3px solid #4299e1;
            background: rgba(66, 153, 225, 0.05);
        }

        .log-entry.error {
            border-left-color: #f56565;
            background: rgba(245, 101, 101, 0.05);
            color: #e53e3e;
        }

        .log-entry.success {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.05);
            color: #38a169;
        }

        .log-entry.warning {
            border-left-color: #ed8936;
            background: rgba(237, 137, 54, 0.05);
            color: #dd6b20;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .connection-status.connected {
            background: #48bb78;
            color: white;
        }

        .connection-status.disconnected {
            background: #f56565;
            color: white;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            border-top-color: #667eea;
            border-right-color: #764ba2;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        /* 고급 로딩 애니메이션 */
        .loading-pulse {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05);
                box-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
            }
        }

        /* 데이터 카드 등장 애니메이션 */
        .symbol-card {
            animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(30px);
        }

        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .status-bar {
                grid-template-columns: 1fr;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status connected pulse" id="connectionStatus">
        <i class="fas fa-wifi"></i> 연결됨
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> MoneyParadise 실시간 데이터 대시보드</h1>
            <p>스마트 데이터 수집 - 온디맨드 검색 및 효율적 모니터링</p>
        </div>

        <div class="status-bar" id="statusBar">
            <div class="status-card">
                <div class="icon" style="color: #2563eb;">
                    <i class="fas fa-server"></i>
                </div>
                <div class="title">시스템 상태</div>
                <div class="value" id="systemStatus">연결 중...</div>
                <div class="subtitle" id="lastUpdate">최종 업데이트: 없음</div>
            </div>

            <div class="status-card">
                <div class="icon" style="color: #059669;">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="title">활성 심볼</div>
                <div class="value" id="activeSymbols">0</div>
                <div class="subtitle">실시간 데이터 수신</div>
            </div>

            <div class="status-card">
                <div class="icon" style="color: #dc2626;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="title">시장 상태</div>
                <div class="value" id="marketStatus">확인 중...</div>
                <div class="subtitle" id="marketTime">시장 시간 계산 중</div>
            </div>
        </div>

        <div class="controls">
            <h3><i class="fas fa-cogs"></i> 시스템 제어</h3>
            <div class="control-buttons">
                <button class="btn" onclick="refreshSmartData()">
                    <i class="fas fa-sync-alt"></i> 데이터 새로고침
                </button>
                <button class="btn" onclick="collectMarketOpen()">
                    <i class="fas fa-sun"></i> 개장 데이터 수집
                </button>
                <button class="btn" onclick="collectMarketClose()">
                    <i class="fas fa-moon"></i> 폐장 데이터 수집
                </button>
                <button class="btn secondary" onclick="addWatchedSymbol()">
                    <i class="fas fa-eye"></i> 관심 티커 추가
                </button>
                <button class="btn danger" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> 로그 삭제
                </button>
            </div>
        </div>

        <!-- 티커 검색 섹션 -->
        <div class="controls">
            <h3><i class="fas fa-search"></i> 티커 검색</h3>
            <div style="position: relative;">
                <input type="text" id="symbolInput" placeholder="티커 또는 회사명 입력 (예: TSLA, 테슬라, Apple)" 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                       onkeyup="handleSymbolInput(event)" onfocus="showSuggestions()" onblur="hideSuggestions()">
                
                <!-- 자동완성 드롭다운 -->
                <div id="suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 200px; overflow-y: auto;">
                </div>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="btn" onclick="searchSymbolInput()">
                    <i class="fas fa-search"></i> 검색
                </button>
                <div style="font-size: 0.9em; color: #6b7280;">
                    실시간 데이터를 온디맨드로 수집합니다
                </div>
            </div>
        </div>

        <!-- TradingView 스타일 차트 인터페이스 -->
        <div class="chart-container" id="chartContainer" style="display: none;">
            <!-- 차트 헤더 -->
            <div class="chart-header">
                <div class="symbol-info">
                    <h2 id="chartSymbol">TSLA</h2>
                    <span class="market-info" id="marketInfo">NASDAQ • 실시간</span>
                </div>
                <div class="price-info">
                    <div class="current-price">
                        <span class="price" id="currentPrice">$440.86</span>
                        <span class="change" id="priceChange">+2.34 (+0.53%)</span>
                    </div>
                    <div class="price-details">
                        <div class="price-item">
                            <span class="label">고가:</span>
                            <span class="value" id="highPrice">$442.50</span>
                        </div>
                        <div class="price-item">
                            <span class="label">저가:</span>
                            <span class="value" id="lowPrice">$438.20</span>
                        </div>
                        <div class="price-item">
                            <span class="label">거래량:</span>
                            <span class="value" id="volume">45.2M</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 차트 메인 영역 -->
            <div class="chart-main">
                <div class="chart-area" id="chartArea">
                    <!-- 캔들스틱 차트가 여기에 표시됩니다 -->
                    <!-- TradingView 위젯 -->
                    <div id="tradingview_widget" style="width: 100%; height: 100%;"></div>
                </div>
                
                <!-- 차트 컨트롤 -->
                <div class="chart-controls">
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active" data-timeframe="1m">1분</button>
                        <button class="timeframe-btn" data-timeframe="5m">5분</button>
                        <button class="timeframe-btn" data-timeframe="15m">15분</button>
                        <button class="timeframe-btn" data-timeframe="1h">1시간</button>
                        <button class="timeframe-btn" data-timeframe="1d">1일</button>
                    </div>
                    <div class="chart-tools">
                        <button class="tool-btn" title="지표 추가"><i class="fas fa-plus"></i></button>
                        <button class="tool-btn" title="추세선"><i class="fas fa-chart-line"></i></button>
                        <button class="tool-btn" title="피보나치"><i class="fas fa-ruler"></i></button>
                        <button class="tool-btn" title="설정"><i class="fas fa-cog"></i></button>
                    </div>
                </div>
            </div>

            <!-- 기술적 지표 패널 -->
            <div class="indicators-panel">
                <h4>기술적 지표</h4>
                <div class="indicators-grid" id="indicatorsGrid">
                    <div class="indicator-item">
                        <div class="indicator-label">RSI (14)</div>
                        <div class="indicator-value" id="rsiValue">52.3</div>
                        <div class="indicator-status neutral">중립</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">MACD</div>
                        <div class="indicator-value" id="macdValue">+1.23</div>
                        <div class="indicator-status bullish">상승</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">볼린저 밴드</div>
                        <div class="indicator-value" id="bbValue">상단 근접</div>
                        <div class="indicator-status warning">주의</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">이동평균</div>
                        <div class="indicator-value" id="maValue">상승 추세</div>
                        <div class="indicator-status bullish">상승</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 기본 데이터 그리드 (차트가 없을 때 표시) -->
        <div class="data-grid" id="dataGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>데이터 로딩 중...</p>
                <div class="loading-message">
                    <p>💡 <strong>팁:</strong> 검색창에 티커를 입력하면 전문적인 차트가 표시됩니다!</p>
                </div>
            </div>
        </div>

        <div class="logs">
            <h3><i class="fas fa-terminal"></i> 실시간 시스템 로그</h3>
            <div id="logContainer">
                <div class="log-entry">
                    MoneyParadise 터보 데이터 프로바이더 초기화 완료
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval = null;
        let isAutoRefresh = true;
        let lastData = {};

        // API 기본 URL
        const API_BASE = 'http://localhost:3001/api/v1';
        
        // 스마트 데이터 시스템 변수
        let smartData = {};
        let marketStatus = {};

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('시스템 초기화 시작', 'success');
            initializeSystem();
            startAutoRefresh();
        });

        // 시스템 초기화
        async function initializeSystem() {
            try {
                updateConnectionStatus(true);
                await refreshSmartData();
                await updateSystemStatus();
                logMessage('시스템 초기화 완료', 'success');
            } catch (error) {
                logMessage(`시스템 초기화 실패: ${error.message}`, 'error');
                updateConnectionStatus(false);
            }
        }

        // 🧠 스마트 데이터 새로고침
        async function refreshSmartData() {
            try {
                updateConnectionStatus(true);
                console.log('🔄 스마트 데이터 새로고침 시작...');
                
                const response = await fetch(`${API_BASE}/smart-data`);
                const data = await response.json();
                
                console.log('📥 API 응답 데이터:', data);
                
                if (data.error) {
                    throw new Error(data.message);
                }

                smartData = data.smartData || {};
                marketStatus = data.smartStatus || {};
                
                console.log('📊 파싱된 스마트 데이터:', smartData);
                console.log('📈 파싱된 마켓 상태:', marketStatus);
                
                updateDataGrid(smartData);
                updateSmartStatus(marketStatus);
                updateLastUpdateTime();
                
                const symbolCount = Object.keys(smartData).length;
                logMessage(`데이터 업데이트: ${symbolCount}개 심볼`, 'success');
                
                // 성공 알림
                showNotification(`${symbolCount}개 심볼 데이터 업데이트 완료`, 'success', 3000);
                
            } catch (error) {
                console.error('❌ 스마트 데이터 새로고침 실패:', error);
                logMessage(`스마트 데이터 새로고침 실패: ${error.message}`, 'error');
                updateConnectionStatus(false);
                showNotification('데이터 새로고침 실패', 'error', 5000);
            }
        }

        // 시스템 상태 업데이트
        function updateSmartStatus(status) {
            console.log('📊 스마트 상태 업데이트:', status);
            
            // 활성 심볼 수 - 실제 데이터 구조에 맞게 수정
            const activeCount = status.cachedSymbols || 0;
            document.getElementById('activeSymbols').textContent = activeCount;
            console.log(`✅ 활성 심볼 수: ${activeCount}`);
            
            // 시장 상태
            const marketInfo = status.marketStatus || {};
            const isMarketOpen = marketInfo.isOpen;
            document.getElementById('marketStatus').textContent = isMarketOpen ? '거래 중' : '폐장';
            document.getElementById('marketStatus').style.color = isMarketOpen ? '#059669' : '#dc2626';
            
            // 시장 시간
            const nextOpen = marketInfo.nextOpenTime;
            const nextClose = marketInfo.nextCloseTime;
            if (nextOpen) {
                const openTime = new Date(nextOpen).toLocaleString();
                document.getElementById('marketTime').textContent = isMarketOpen ? 
                    `폐장: ${new Date(nextClose).toLocaleTimeString()}` : 
                    `개장: ${openTime}`;
            }
            
            // 사용자 검색한 심볼 표시
            const userSearched = status.userSearchedSymbols || [];
            if (userSearched.length > 0) {
                console.log(`🔍 사용자 검색 심볼: ${userSearched.join(', ')}`);
            }
        }

        // 데이터 새로고침
        async function refreshData() {
            try {
                updateConnectionStatus(true);
                
                const response = await fetch(`${API_BASE}/market-data`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }

                updateDataGrid(data.cachedData || {});
                updateLastUpdateTime();
                
                logMessage(`${Object.keys(data.cachedData || {}).length}개 심볼 데이터 업데이트 완료`, 'success');
                
            } catch (error) {
                logMessage(`데이터 새로고침 실패: ${error.message}`, 'error');
                updateConnectionStatus(false);
            }
        }

        // 시스템 상태 업데이트
        async function updateSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                
                // 활성 심볼 수 업데이트
                const activeCount = Object.keys(lastData).length;
                document.getElementById('activeSymbols').textContent = activeCount;
                
                // 시스템 상태 업데이트
                if (data.status === 'healthy') {
                    document.getElementById('systemStatus').textContent = '정상 운영';
                    document.getElementById('systemStatus').style.color = '#48bb78';
                } else {
                    document.getElementById('systemStatus').textContent = '점검 필요';
                    document.getElementById('systemStatus').style.color = '#f56565';
                }

            } catch (error) {
                logMessage(`상태 업데이트 실패: ${error.message}`, 'error');
            }
        }

        // 데이터 그리드 업데이트 (고급 UX)
        function updateDataGrid(data) {
            lastData = data;
            
            const grid = document.getElementById('dataGrid');
            const symbols = Object.keys(data);
            
            if (symbols.length === 0) {
                grid.innerHTML = `
                    <div class="loading loading-pulse">
                        <div class="spinner"></div>
                        <p>🧠 스마트 데이터 로딩 중...</p>
                        <small>온디맨드 수집으로 효율성 극대화</small>
                    </div>
                `;
                return;
            }

            // 기존 카드들을 부드럽게 제거
            const existingCards = grid.querySelectorAll('.symbol-card');
            existingCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.animation = 'slideOut 0.3s ease forwards';
                    setTimeout(() => card.remove(), 300);
                }, index * 50);
            });

            // 새로운 카드들을 순차적으로 추가
            setTimeout(() => {
                grid.innerHTML = symbols.map((symbol, index) => {
                    setTimeout(() => {
                        const cardElement = document.createElement('div');
                        cardElement.innerHTML = createSymbolCardHTML(symbol, data[symbol]);
                        cardElement.className = 'symbol-card';
                        cardElement.style.animationDelay = `${index * 100}ms`;
                        grid.appendChild(cardElement);
                    }, index * 100);
                    
                    return createSymbolCardHTML(symbol, data[symbol]);
                }).join('');
            }, existingCards.length * 50);
        }

        // 심볼 카드 HTML 생성 함수
        function createSymbolCardHTML(symbol, item) {
                const change = item.change || 0;
                const changeClass = change > 0 ? 'up' : change < 0 ? 'down' : 'neutral';
            const changeIcon = change > 0 ? '📈' : change < 0 ? '📉' : '➡️';
                
                return `
                <div class="symbol-card ${changeClass}" style="animation-delay: 0ms;">
                        <div class="symbol-header">
                        <div class="symbol-name">
                            ${symbol}
                            <span style="font-size: 0.8em; margin-left: 8px;">${changeIcon}</span>
                        </div>
                        <div class="symbol-source">
                            ${item.source || '알 수 없음'}
                            ${item.collectionType ? `<br><small>${item.collectionType}</small>` : ''}
                        </div>
                        </div>
                        
                        <div class="price-info">
                            <div class="price-main">
                                <div class="current-price">$${formatPrice(item.currentPrice)}</div>
                                <div class="change-info">
                                    <div class="change ${changeClass}">
                                        ${change > 0 ? '+' : ''}${formatPrice(change)}
                                    </div>
                                    <div class="change-percent">
                                        ${item.changePercent ? formatPercent(item.changePercent) : 'N/A'}%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="price-details">
                                <div class="price-item">시초 <span>$${formatPrice(item.open)}</span></div>
                                <div class="price-item">고가 <span>$${formatPrice(item.high)}</span></div>
                                <div class="price-item">저가 <span>$${formatPrice(item.low)}</span></div>
                                <div class="price-item">거래량 <span>${formatVolume(item.volume)}</span></div>
                            </div>
                        </div>
                        
                        <div class="update-time">
                        ${item.cached ? '💾 캐시된 데이터' : ''}
                            ${item.lastRefreshed ? '업데이트: ' + formatTime(item.lastRefreshed) : ''}
                        ${item.cacheAge ? ` (${Math.round(item.cacheAge / 1000)}초 전)` : ''}
                        </div>
                    </div>
                `;
        }

        // 자동 새로고침 시작
        function startAutoRefresh() {
            if (updateInterval) return;
            
            isAutoRefresh = true;
            updateInterval = setInterval(() => {
                if (isAutoRefresh) {
                    refreshData();
                    updateSystemStatus();
                }
            }, 5000); // 5초마다 새로고침
            
            logMessage('자동 새로고침 시작 (5초 간격)', 'success');
        }

        // 자동 새로고침 중단
        function stopAutoRefresh() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
                isAutoRefresh = false;
                logMessage('자동 새로고침 중단', 'warning');
            }
        }

        // 📢 반응형 피드백 시스템
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span class="status-indicator ${type}"></span>
                    <span style="font-weight: 500;">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 애니메이션으로 표시
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 자동 제거
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, duration);
        }

        function updateButtonState(buttonSelector, state, text) {
            const button = document.querySelector(buttonSelector);
            if (button) {
                button.disabled = state === 'loading';
                button.className = button.className.replace(/loading/g, '');
                if (state === 'loading') button.className += ' loading';
                button.innerHTML = text;
            }
        }

        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('systemStatus');
            if (statusElement) {
                if (isConnected) {
                    statusElement.innerHTML = '<span class="status-indicator success"></span>연결됨';
                    statusElement.style.color = '#059669';
                } else {
                    statusElement.innerHTML = '<span class="status-indicator error"></span>연결 끊김';
                    statusElement.style.color = '#dc2626';
                }
            }
        }

        // 🔍 온디맨드 티커 검색 (한국어 지원 + 반응형 피드백)
        async function searchSymbolInput() {
            const symbolInput = document.getElementById('symbolInput');
            let symbol = symbolInput.value.trim();
            
            if (!symbol) {
                logMessage('티커 심볼 또는 회사명을 입력해주세요', 'warning');
                return;
            }

            // 반응형 피드백 시작
            updateButtonState('button[onclick="searchSymbolInput()"]', 'loading', '<i class="fas fa-spinner fa-spin"></i> 검색 중...');
            showNotification('검색을 시작합니다...', 'info', 2000);

            // 한국어 또는 영어 회사명으로 검색된 경우 티커 심볼로 변환
            const foundStock = popularStocks.find(stock => 
                stock.symbol.toUpperCase() === symbol.toUpperCase() || 
                stock.name.toUpperCase().includes(symbol.toUpperCase()) ||
                stock.korean.includes(symbol)
            );
            
            if (foundStock) {
                symbol = foundStock.symbol;
                symbolInput.value = symbol; // 입력창에 정확한 티커 표시
                logMessage(`🔍 ${symbol} (${foundStock.korean}) 검색 시작...`, 'info');
                showNotification(`${foundStock.korean} (${symbol}) 검색 중...`, 'info', 2000);
            } else {
                symbol = symbol.toUpperCase(); // 입력값을 대문자로 변환
                logMessage(`🔍 ${symbol} 검색 시작...`, 'info');
                showNotification(`${symbol} 검색 중...`, 'info', 2000);
            }
            
            try {
                await searchOnDemandSymbol(symbol);
            } finally {
                // 검색 버튼 다시 활성화
                updateButtonState('button[onclick="searchSymbolInput()"]', 'normal', '<i class="fas fa-search"></i> 검색');
            }
        }

        // 📋 인기 주식 데이터베이스
        const popularStocks = [
            { symbol: 'AAPL', name: 'Apple Inc.', korean: '애플' },
            { symbol: 'MSFT', name: 'Microsoft Corporation', korean: '마이크로소프트' },
            { symbol: 'GOOGL', name: 'Alphabet Inc.', korean: '구글' },
            { symbol: 'AMZN', name: 'Amazon.com Inc.', korean: '아마존' },
            { symbol: 'TSLA', name: 'Tesla Inc.', korean: '테슬라' },
            { symbol: 'META', name: 'Meta Platforms Inc.', korean: '메타' },
            { symbol: 'NVDA', name: 'NVIDIA Corporation', korean: '엔비디아' },
            { symbol: 'AMD', name: 'Advanced Micro Devices', korean: 'AMD' },
            { symbol: 'NFLX', name: 'Netflix Inc.', korean: '넷플릭스' },
            { symbol: 'INTC', name: 'Intel Corporation', korean: '인텔' },
            { symbol: 'CRM', name: 'Salesforce Inc.', korean: '세일즈포스' },
            { symbol: 'ADBE', name: 'Adobe Inc.', korean: '어도비' },
            { symbol: 'PYPL', name: 'PayPal Holdings Inc.', korean: '페이팔' },
            { symbol: 'UBER', name: 'Uber Technologies Inc.', korean: '우버' },
            { symbol: 'SPOT', name: 'Spotify Technology S.A.', korean: '스포티파이' },
            { symbol: 'SNAP', name: 'Snap Inc.', korean: '스냅' },
            { symbol: 'TWTR', name: 'Twitter Inc.', korean: '트위터' },
            { symbol: 'SQ', name: 'Block Inc.', korean: '블록' },
            { symbol: 'ROKU', name: 'Roku Inc.', korean: '로쿠' },
            { symbol: 'ZM', name: 'Zoom Video Communications', korean: '줌' }
        ];

        // 🔍 자동완성 기능 (한국어 지원 강화)
        function handleSymbolInput(event) {
            const input = event.target.value.trim();
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (input.length < 1) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // 검색어와 매칭되는 주식 찾기 (한국어, 영어 모두 지원)
            const matches = popularStocks.filter(stock => 
                stock.symbol.toUpperCase().includes(input.toUpperCase()) || 
                stock.name.toUpperCase().includes(input.toUpperCase()) ||
                stock.korean.includes(input) ||
                stock.korean.includes(input.toUpperCase()) // 대소문자 무관 한국어 검색
            );

            if (matches.length > 0) {
                // 최대 8개까지만 표시
                const limitedMatches = matches.slice(0, 8);
                
                suggestionsDiv.innerHTML = limitedMatches.map(stock => {
                    // 검색어 하이라이트 함수
                    const highlightText = (text, searchTerm) => {
                        if (!searchTerm) return text;
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        return text.replace(regex, '<mark style="background-color: #fef3c7; color: #92400e;">$1</mark>');
                    };

                    return `<div class="suggestion-item" onclick="selectSuggestion('${stock.symbol}')" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s;"
                             onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='white'">
                        <div>
                            <div style="font-weight: bold; color: #2563eb;">${highlightText(stock.symbol, input)}</div>
                            <div style="font-size: 0.9em; color: #6b7280;">${highlightText(stock.name, input)}</div>
                        </div>
                        <div style="font-size: 0.8em; color: #9ca3af;">${highlightText(stock.korean, input)}</div>
                    </div>`;
                }).join('');
                
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        // 🎯 자동완성 선택
        function selectSuggestion(symbol) {
            document.getElementById('symbolInput').value = symbol;
            document.getElementById('suggestions').style.display = 'none';
            searchSymbolInput(); // 자동으로 검색 실행
        }

        // 👁️ 자동완성 표시/숨김
        function showSuggestions() {
            const input = document.getElementById('symbolInput').value.trim();
            if (input.length >= 1) {
                handleSymbolInput({ target: document.getElementById('symbolInput') });
            }
        }

        function hideSuggestions() {
            // 약간의 지연을 두어 클릭 이벤트가 먼저 실행되도록
            setTimeout(() => {
                document.getElementById('suggestions').style.display = 'none';
            }, 200);
        }

        // 🔍 온디맨드 심볼 검색 (반응형 피드백 적용)
        async function searchOnDemandSymbol(symbol) {
            try {
                logMessage(`${symbol} 검색 시작...`, 'info');
                
                // 반응형 로딩 상태 표시
                document.getElementById('chartContainer').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>${symbol} 데이터 로딩 중...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="searchProgress"></div>
                        </div>
                    </div>
                `;
                
                // 진행률 애니메이션
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress > 90) progress = 90;
                    const progressBar = document.getElementById('searchProgress');
                    if (progressBar) progressBar.style.width = progress + '%';
                }, 200);
                
                showNotification(`${symbol} 서버에서 데이터 요청 중...`, 'info', 2000);
                
                const response = await fetch(`${API_BASE}/smart-data/${symbol}`);
                const data = await response.json();
                
                clearInterval(progressInterval);
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                logMessage(`✅ ${symbol} 검색 성공 (${data.source})`, 'success');
                showNotification(`${symbol} 데이터 수집 성공!`, 'success', 3000);
                
                // TradingView 스타일 차트 인터페이스 표시
                if (data.data) {
                    const symbolData = data.data;
                    logMessage(`📊 ${symbol} 데이터 파싱 중...`, 'info');
                    
                    // 진행률 100% 완료
                    const progressBar = document.getElementById('searchProgress');
                    if (progressBar) progressBar.style.width = '100%';
                    
                    setTimeout(() => {
                        // 기본 데이터 그리드 숨기고 차트 컨테이너 표시
                        document.getElementById('dataGrid').style.display = 'none';
                        document.getElementById('chartContainer').style.display = 'block';
                        
                        // 차트 데이터 업데이트
                        updateChartInterface(symbolData);
                        
                        const price = symbolData.currentPrice?.toFixed(2) || 'N/A';
                        const change = symbolData.changePercent ? (symbolData.changePercent > 0 ? '+' : '') + symbolData.changePercent.toFixed(2) + '%' : 'N/A';
                        
                        logMessage(`🎯 ${symbol} 전문 차트 표시 완료! 가격: $${price}, 변동: ${change}`, 'success');
                        showNotification(`${symbol}: $${price} (${change}) - 전문 차트 활성화`, 'success', 4000);
                    }, 500);
                    
                } else {
                    logMessage(`❌ ${symbol} 응답 데이터가 비어있습니다`, 'error');
                    throw new Error('데이터를 찾을 수 없습니다');
                }
                
            } catch (error) {
                logMessage(`${symbol} 검색 실패: ${error.message}`, 'error');
                showNotification(`${symbol} 검색 실패: ${error.message}`, 'error', 5000);
                
                document.getElementById('dataGrid').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                        <h3>검색 실패</h3>
                        <p>${symbol} 데이터를 찾을 수 없습니다.</p>
                        <button class="btn" onclick="refreshSmartData()" style="margin-top: 20px;">
                            <i class="fas fa-refresh"></i> 다시 시도
                        </button>
                    </div>
                `;
            }
        }

        // 📊 차트 인터페이스 업데이트
        function updateChartInterface(symbolData) {
            try {
                // 기본 정보 업데이트
                document.getElementById('chartSymbol').textContent = symbolData.symbol;
                document.getElementById('marketInfo').textContent = 'NASDAQ • 실시간';
                
                // 가격 정보 업데이트
                const currentPrice = symbolData.currentPrice?.toFixed(2) || 'N/A';
                document.getElementById('currentPrice').textContent = `$${currentPrice}`;
                
                // 변동률 계산 및 표시
                const change = symbolData.change || 0;
                const changePercent = symbolData.changePercent || 0;
                const changeElement = document.getElementById('priceChange');
                
                if (change > 0) {
                    changeElement.textContent = `+${change.toFixed(2)} (+${changePercent.toFixed(2)}%)`;
                    changeElement.className = 'change positive';
                } else if (change < 0) {
                    changeElement.textContent = `${change.toFixed(2)} (${changePercent.toFixed(2)}%)`;
                    changeElement.className = 'change negative';
                } else {
                    changeElement.textContent = `${change.toFixed(2)} (${changePercent.toFixed(2)}%)`;
                    changeElement.className = 'change neutral';
                }
                
                // 상세 가격 정보 업데이트
                document.getElementById('highPrice').textContent = `$${(symbolData.high || symbolData.currentPrice || 0).toFixed(2)}`;
                document.getElementById('lowPrice').textContent = `$${(symbolData.low || symbolData.currentPrice || 0).toFixed(2)}`;
                
                // 거래량 포맷팅
                const volume = symbolData.volume || 0;
                let volumeText = 'N/A';
                if (volume > 0) {
                    if (volume >= 1000000000) {
                        volumeText = `${(volume / 1000000000).toFixed(1)}B`;
                    } else if (volume >= 1000000) {
                        volumeText = `${(volume / 1000000).toFixed(1)}M`;
                    } else if (volume >= 1000) {
                        volumeText = `${(volume / 1000).toFixed(1)}K`;
                    } else {
                        volumeText = volume.toLocaleString();
                    }
                }
                document.getElementById('volume').textContent = volumeText;
                
                // 기술적 지표 업데이트 (실제 데이터가 있으면 사용, 없으면 모의 데이터)
                // TradingView 차트 생성 (임시 주석 처리)
                // createTradingViewChart(symbolData);
                
                updateTechnicalIndicators(symbolData);
                
                logMessage(`📈 ${symbolData.symbol} 차트 인터페이스 업데이트 완료`, 'info');
                
            } catch (error) {
                logMessage(`❌ 차트 인터페이스 업데이트 실패: ${error.message}`, 'error');
            }
        }

        // 📊 기술적 지표 업데이트
        function updateTechnicalIndicators(symbolData) {
            try {
                // RSI 계산 (간단한 모의 계산)
                const rsi = calculateMockRSI(symbolData);
                document.getElementById('rsiValue').textContent = rsi.toFixed(1);
                const rsiStatus = rsi > 70 ? 'bearish' : rsi < 30 ? 'bullish' : 'neutral';
                document.querySelector('#rsiValue').nextElementSibling.className = `indicator-status ${rsiStatus}`;
                document.querySelector('#rsiValue').nextElementSibling.textContent = rsi > 70 ? '과매수' : rsi < 30 ? '과매도' : '중립';
                
                // MACD 계산 (간단한 모의 계산)
                const macd = calculateMockMACD(symbolData);
                document.getElementById('macdValue').textContent = macd > 0 ? `+${macd.toFixed(2)}` : macd.toFixed(2);
                const macdStatus = macd > 0 ? 'bullish' : 'bearish';
                document.querySelector('#macdValue').nextElementSibling.className = `indicator-status ${macdStatus}`;
                document.querySelector('#macdValue').nextElementSibling.textContent = macd > 0 ? '상승' : '하락';
                
                // 볼린저 밴드 상태 (모의 계산)
                const bbStatus = calculateMockBBStatus(symbolData);
                document.getElementById('bbValue').textContent = bbStatus.text;
                document.querySelector('#bbValue').nextElementSibling.className = `indicator-status ${bbStatus.status}`;
                document.querySelector('#bbValue').nextElementSibling.textContent = bbStatus.label;
                
                // 이동평균 상태 (모의 계산)
                const maStatus = calculateMockMAStatus(symbolData);
                document.getElementById('maValue').textContent = maStatus.text;
                document.querySelector('#maValue').nextElementSibling.className = `indicator-status ${maStatus.status}`;
                document.querySelector('#maValue').nextElementSibling.textContent = maStatus.label;
                
            } catch (error) {
                logMessage(`❌ 기술적 지표 업데이트 실패: ${error.message}`, 'error');
            }
        }

        // TradingView 차트 생성
        let tradingViewWidget = null;
        
        function createTradingViewChart(symbolData) {
            // 기존 위젯 제거
            if (tradingViewWidget) {
                tradingViewWidget.remove();
            }
            
            // TradingView 위젯 생성
            tradingViewWidget = new TradingView.widget({
                "autosize": true,
                "symbol": `${symbolData.symbol}`,
                "interval": "1",
                "timezone": "Asia/Seoul",
                "theme": "light",
                "style": "1",
                "locale": "ko",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "withdateranges": true,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "details": true,
                "hotlist": true,
                "calendar": true,
                "studies": [
                    "Volume@tv-basicstudies",
                    "RSI@tv-basicstudies", 
                    "MACD@tv-basicstudies",
                    "BB@tv-basicstudies",
                    "Stochastic@tv-basicstudies",
                    "Williams%R@tv-basicstudies",
                    "CCI@tv-basicstudies"
                ],
                "container_id": "tradingview_widget",
                "show_popup_button": true,
                "popup_width": "1000",
                "popup_height": "650",
                "no_referral_id": true,
                "referral_id": "your_referral_id", // 유료 계정에서 수익화 가능
                "disabled_features": [
                    "use_localstorage_for_settings",
                    "volume_force_overlay",
                    "create_volume_indicator_by_default"
                ],
                "enabled_features": [
                    "side_toolbar_in_fullscreen_mode",
                    "header_in_fullscreen_mode",
                    "use_localstorage_for_settings"
                ],
                "overrides": {
                    "paneProperties.background": "#ffffff",
                    "paneProperties.vertGridProperties.color": "#e1e3e6",
                    "paneProperties.horzGridProperties.color": "#e1e3e6",
                    "symbolWatermarkProperties.transparency": 90,
                    "scalesProperties.textColor": "#131722"
                },
                "studies_overrides": {
                    "volume.volume.color.0": "#00bcd4",
                    "volume.volume.color.1": "#0000ff",
                    "volume.volume.transparency": 70
                }
            });
            
            console.log(`📊 TradingView 차트 생성 완료: ${symbolData.symbol}`);
        }
        
        async function createRealTimeChart(symbolData) {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            
            // 기존 차트 제거
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            try {
                // 실제 과거 데이터 가져오기
                console.log(`📊 ${symbolData.symbol} 실제 과거 데이터 요청 중...`);
                
                const response = await fetch(`${API_BASE}/historical-data/${symbolData.symbol}?period=1mo&interval=1d`);
                const historicalResult = await response.json();
                
                if (!historicalResult.success) {
                    throw new Error(historicalResult.message || '과거 데이터 수집 실패');
                }
                
                const historicalData = historicalResult.data.data;
                console.log(`✅ ${symbolData.symbol} 과거 데이터 수집 완료: ${historicalData.length}개 데이터 포인트`);
                
                // 실제 데이터로 차트 생성
                const labels = historicalData.map(item => {
                    const date = new Date(item.timestamp);
                    return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
                });
                
                const prices = historicalData.map(item => item.close);
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: symbolData.symbol,
                        data: prices,
                        borderColor: symbolData.change >= 0 ? '#059669' : '#dc2626',
                        backgroundColor: symbolData.change >= 0 ? 'rgba(5, 150, 105, 0.1)' : 'rgba(220, 38, 38, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: symbolData.change >= 0 ? '#059669' : '#dc2626',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#374151',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            },
                            ticks: {
                                color: '#6b7280',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            },
                            ticks: {
                                color: '#6b7280',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 6
                        }
                    }
                }
            });
            
            } catch (error) {
                console.error('차트 생성 오류:', error);
                // 오류 발생 시 기본 메시지 표시
                ctx.innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">차트 데이터를 불러올 수 없습니다</p>';
            }
        }
        
        // 📈 모의 기술적 지표 계산 함수들
        function calculateMockRSI(symbolData) {
            // 간단한 RSI 모의 계산 (실제로는 과거 데이터가 필요)
            const price = symbolData.currentPrice || 0;
            const volatility = Math.random() * 20 + 30; // 30-50 사이의 랜덤 값
            return volatility;
        }

        function calculateMockMACD(symbolData) {
            // 간단한 MACD 모의 계산
            const price = symbolData.currentPrice || 0;
            const trend = (price % 100) / 100 - 0.5; // -0.5 ~ 0.5 사이의 트렌드
            return trend * 5; // -2.5 ~ 2.5 사이의 값
        }

        function calculateMockBBStatus(symbolData) {
            // 볼린저 밴드 상태 모의 계산
            const price = symbolData.currentPrice || 0;
            const random = Math.random();
            
            if (random < 0.3) {
                return { text: '상단 근접', status: 'warning', label: '주의' };
            } else if (random < 0.3) {
                return { text: '하단 근접', status: 'warning', label: '주의' };
            } else {
                return { text: '중간대', status: 'neutral', label: '중립' };
            }
        }

        function calculateMockMAStatus(symbolData) {
            // 이동평균 상태 모의 계산
            const price = symbolData.currentPrice || 0;
            const trend = (price % 10) / 10 - 0.5;
            
            if (trend > 0.2) {
                return { text: '상승 추세', status: 'bullish', label: '상승' };
            } else if (trend < -0.2) {
                return { text: '하락 추세', status: 'bearish', label: '하락' };
            } else {
                return { text: '횡보', status: 'neutral', label: '중립' };
            }
        }

        // 🕘 개장 데이터 수집
        async function collectMarketOpen() {
            try {
                logMessage('개장 데이터 수집 시작...', 'info');
                
                const response = await fetch(`${API_BASE}/smart-data/market-open`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                logMessage(`개장 데이터 수집 완료: ${data.successCount}/${data.totalCount} 성공`, 'success');
                await refreshSmartData();
                
            } catch (error) {
                logMessage(`개장 데이터 수집 실패: ${error.message}`, 'error');
            }
        }

        // 🕔 폐장 데이터 수집
        async function collectMarketClose() {
            try {
                logMessage('🕔 폐장 데이터 수집 시작...', 'info');
                
                const response = await fetch(`${API_BASE}/smart-data/market-close`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                logMessage(`🕔 폐장 데이터 수집 완료: ${data.successCount}/${data.totalCount} 성공`, 'success');
                await refreshSmartData();
                
            } catch (error) {
                logMessage(`폐장 데이터 수집 실패: ${error.message}`, 'error');
            }
        }

        // 👀 관심 티커 추가
        async function addWatchedSymbol() {
            const symbol = prompt('관심 티커를 입력하세요 (예: AAPL):');
            if (!symbol) return;
            
            try {
                logMessage(`👀 ${symbol} 관심 티커 추가 중...`, 'info');
                
                const response = await fetch(`${API_BASE}/smart-data/watch/${symbol}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                logMessage(`👀 ${symbol} 관심 티커 추가 완료 (5분마다 업데이트)`, 'success');
                
            } catch (error) {
                logMessage(`관심 티커 추가 실패: ${error.message}`, 'error');
            }
        }

        // 🎯 4단계 자동 전환 시스템 테스트
        async function testFailoverChain() {
            const testSymbols = ['AAPL', 'INVALID_SYMBOL', 'TSLA'];
            
            logMessage('🎯 4단계 자동 전환 시스템 테스트 시작...', 'info');
            logMessage('🔥 Yahoo Finance → 🌐 Investing.com → 📊 Finviz → ⭐ Alpha Vantage', 'info');
            
            for (const symbol of testSymbols) {
                try {
                    await searchOnDemandSymbol(symbol);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1초 대기
                } catch (error) {
                    logMessage(`⚠️ ${symbol} 테스트에서 오류 발생 (예상된 동작)`, 'warning');
                }
            }
            
            logMessage('🎯 4단계 자동 전환 시스템 테스트 완료', 'success');
        }

        // 수집 시작 함수 (레거시)
        async function startCollection() {
            try {
                const response = await fetch(`${API_BASE}/market-data/refresh`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }
                
                logMessage('🎯 4단계 자동 전환 시스템 데이터 수집 시작', 'success');
                await refreshSmartData();
                
            } catch (error) {
                logMessage(`수집 시작 실패: ${error.message}`, 'error');
            }
        }

        // 수집 중단 함수
        function stopCollection() {
            stopAutoRefresh();
            logMessage('데이터 수집 중단', 'warning');
        }

        // 로그 메시지 추가
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 로그가 너무 많으면 오래된 것 삭제
            const logs = logContainer.children;
            if (logs.length > 50) {
                logContainer.removeChild(logs[1]);
            }
        }

        // 로그 삭제
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = `
                <div class="log-entry">
                    로그가 삭제되었습니다. 새로운 시스템 활동이 여기에 표시됩니다.
                </div>
            `;
        }

        // 연결 상태 업데이트
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-wifi"></i> 연결됨';
                statusElement.className = 'connection-status connected';
                statusElement.classList.add('pulse');
            } else {
                statusElement.innerHTML = '<i class="fas fa-wifi"></i> 연결 끊김';
                statusElement.className = 'connection-status disconnected';
                statusElement.classList.remove('pulse');
            }
        }

        // 최종 업데이트 시간 업데이트
        function updateLastUpdateTime() {
            const now = new Date().toLocaleString();
            document.getElementById('lastUpdate').textContent = `최종 업데이트: ${now}`;
        }

        // 유틸리티 함수들
        function formatPrice(price) {
            if (typeof price !== 'number') return 'N/A';
            return price.toFixed(2);
        }

        function formatPercent(percent) {
            if (typeof percent !== 'number') return '0';
            return percent.toFixed(2);
        }

        function formatVolume(volume) {
            if (typeof volume !== 'number') return 'N/A';
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(1) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            }
            return volume.toLocaleString();
        }

        function formatTime(timeString) {
            try {
                const date = new Date(timeString);
                return date.toLocaleTimeString();
            } catch (error) {
                return '알 수 없음';
            }
        }

        // 페이지 언로드시 정리
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
